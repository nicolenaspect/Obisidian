
Проучване на Тали Гарсиел.

## Предговор

> В годините, когато IE доминираше с 90 %, нямаше какво друго да се направи, освен да се гледа на браузъра като на "черна кутия", но сега, когато браузърите с отворен код имат повече от половината от дела на използване, е добър момент да надникнем под капака на двигателя и да видим какво се крие в уеб браузъра. Е, това, което е вътре, са милиони редове C++.                                 Тали Гарсиел,

Като уеб разработчик изучаването на вътрешната част на операциите на браузъра ви помага да вземете по-добри решения и да знаете основанията за най-добрите практики за разработка. 

## Въведение 


Уеб браузърите са най-широко използваният софтуер. В този уводен материал ще обясня как работят те зад кулисите. Ще видим какво се случва, когато въведете google.com в адресната лента, докато видите страницата на Google на екрана на браузъра.

Днес в настолните компютри се използват пет основни браузъра: `Chrome, Internet Explorer, Firefox, Safari и Opera`. При мобилните устройства основните браузъри са `Android Browser, Iphone, Opera Mini и Opera Mobile, UC Browser, браузърите на Nokia S40/S60 и Chrome`, като всички те с изключение на Opera са базирани на WebKit. Според статистиката на StatCounter (към юни 2013г.) Chrome, Firefox и Safari съставляват около 71% от световното използване на браузъри за настолни компютри. 


## Основната функция на браузърите 

Основната функция на браузъра е да представя избрания от вас уеб ресурс, като го изисква от сървъра и го показва в прозореца на браузъра. Ресурсът обикновено е HTML документ, но може да бъде и всякакъв друг вид съдържание. Местоположението на ресурса се определя с помощта на URI (Uniform Resource Identifier).

Начинът, по който показва и интерпретира HTML файловете е определен в спецификациите на HTML и CSS. Тези спецификации се поддържат от организацията WSC (World Wide Web Consortium) , която е организацията за стандартизация на уеб. В продължение на години браузърите спазваха само част от спецификациите и разработваха свои собствени разширения. Това доведе до проблеми със съвместимостта за авторите на уебсайтове. Днес повечето браузъри в по-голяма или по-малка степен отговарят на спецификациите. 

Потребителските интерфейси на браузърите имат много общо помежду си. Сред общите елементи са:

1.  Address bar for inserting a URI
2.  Back and forward buttons
3.  Bookmarking options
4.  Refresh and stop buttons for refreshing or stopping the loading of current documents
5.  Home button that takes you to your home page

Потребителският интерфейс на браузъра не е описан в никаква официална спецификация, а е резултат на добрите практики, формирани с години и от подражанието  на браузърите един на друг.  Спецификацията на HTML5 не определя елементите на потребителския интерфейс, които браузърът трябва да има, но изброява някои общи елементи. Сред тях са адресната лента, лентата на състоянието и лентата с инструменти. Разбира се, има и функции, които са уникални за даден браузър, като например мениджъра за изтегляне на Firefox.

## Структура на браузърите 

1.  The User Interface -  това включва адресната лента, бутона за връщане назад/напред, менюто за отметки и др. Всяка част от дисплея на браузъра, с изключение на прозореца, в който се вижда заявената страница.  
2. The Browser Engine - прехвърля действията между UI и двигателя за визуализация (rendering engine) 
3. The Rendering Engine - отговаря за показването на заявеното съдържание. 
4. Networking - за мрежови извиквания, като например [[HTTP]] заявки
5. UI backend - използва се за basic приставки - combo boxes и прозорци. Предоставя общ интерфейс, който не е специфичен за дадена платформа. Под него се използват методите на потребителския интерфейс на OS.
6. JavaScript interpreter - за анализиране и изпълнение на JavaScript код.
7. Data Storage - Слой за устойчивост. Браузърът може да се нуждае от локално запазване на всякакви данни, като например бисквитки. Браузърите поддържат и механизми за съхранение като localStorage, IndexedDB, WebSQL и FileSystem.

Важно е да се отбележи, че в браузъри като Chrome се използват няколко екземпляра на енджина за визуализация: по един за всеки раздел. Всеки раздел се изпълнява в отделен процес.

## Rendering Engines

Отговорността на енджина за визуализация е... визуализация, т.е. показване на заявеното съдържание на екрана на браузъра.

По подразбиране енджинът за рендиране може да показва HTML и XML документи и изображения. Той може да показва и други типове данни чрез приставки или разширения; например, да показва PDF документи, като използва приставка за преглед на PDF. 

Различните браузъри използват различни енджини: IE използва `Trident`, Firefox използва `Gecko`, Safari използва WebKit, а Chrome и Opera (от версия 15) използват `Blink`, разклонение на WebKit

## Основният поток 

Енджинът ще започне да получава съдържанието на заявения документ от мрежовия слой. Обикновено това се извършва на части от 8kb. 

	![[Pasted image 20230202150130.png]]Основен поток на механизма за рендиране

Рендиращата машина ще започне да анализира HTML документа и ще преобразува елементите във възли DOM в дърво, наречено `content tree`. Енджинът ще анализира данните за стиловете, както във външните CSS файлове, така и в елементите на стиловете. Информацията за стила заедно с визуалните инструкции в HTML ще се използва за създаване на друго дърво, `render tree`-.

`The render tree` съдържа правоъгълници с визуални атрибути като цвят и размери. Те са подредени в правилния ред, за да се покажат на екрана.

След построяването на дървото на визуализацията то преминава през процес на оформление. На всеки `node` се задават точните координати, в които трябва да се появи на екрана. Следващият етап е рисуването - дървото на рендерите ще бъде обходено и всеки възел ще бъде нарисуван с помощта на бекенд слоя на потребителския интерфейс.

Важно е да разберете, че това е постепенен процес. За по-добро потребителско изживяване механизмът за рендиране ще се опита да покаже съдържанието на екрана възможно най-скоро. Той няма да изчака, докато целият HTML бъде анализиран, преди да започне да изгражда и подрежда дървото на визуализация. Части от съдържанието ще бъдат анализирани и показани, докато процесът продължава с останалото съдържание, което продължава да идва от мрежата.

## Основни примери за потоци 

![[Pasted image 20230203150213.png]]

Gecko нарича визуално форматираните елементи `Frame Tree` , а в WebKit е `Render Tree`. 

## Parsing - General


Тъй като парсингът е много важен процес в енджина за визуализация, ще го разгледаме малко по-задълбочено. Нека започнем с малко въведение за парсинга.

Парсирането на документ означава превеждането му в структура, която кодът може да използва. Резултатът от парсинга обикновено е дърво от възли, които представят структурата на документа. Това се нарича `tree nodes` или синтактично дърво.

For example, parsing the expression `2 + 3 - 1` could return this tree:
![[xNQUG9emGd8FzuOpumP7.avif]]